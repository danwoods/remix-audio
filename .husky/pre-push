# Run tests with coverage before push
echo "ðŸ§ª Running tests with coverage before push..."
deno task test:coverage:ci

if [ $? -ne 0 ]; then
  echo "âŒ Tests or coverage check failed. Push aborted."
  exit 1
fi

# Update baseline if coverage stayed same or improved; amend to latest commit if it changed
deno run --allow-read --allow-write scripts/coverage-check.ts --write-baseline
if [ $? -ne 0 ]; then
  echo "âŒ Coverage baseline write failed. Push aborted."
  exit 1
fi

# Only amend if baseline changed, we have a commit, and HEAD is not already on remote
safe_to_amend=false
current_ref=$(git symbolic-ref -q HEAD)
if [ -n "$current_ref" ]; then
  while read -r local_ref local_sha remote_ref remote_sha; do
    [ -z "$local_ref" ] && break
    if [ "$local_ref" = "$current_ref" ]; then
      if [ "$remote_sha" = "0000000000000000000000000000000000000000" ] || [ "$local_sha" != "$remote_sha" ]; then
        safe_to_amend=true
      fi
      break
    fi
  done
fi

if [ "$safe_to_amend" = true ] && [ -n "$(git status --porcelain coverage-baseline.json 2>/dev/null)" ] && git rev-parse -q --verify HEAD >/dev/null 2>&1; then
  git add coverage-baseline.json && git commit --amend --no-edit
  echo "âœ… Updated coverage baseline amended to the previous commit."
fi

echo "âœ… All tests passed!"
